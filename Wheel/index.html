<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vòng Quay May Mắn ITC</title>
  <link rel="stylesheet" href="css/typo/typo.css" />
  <link rel="stylesheet" href="css/hc-canvas-luckwheel.css" />
  <link href=./images/hengaplai.png rel="icon" type="image/x-icon" />

  <style>
    body {
      background-color: #f0f0f0;
      margin: 0;
      padding: 0;
    }

    .hc-luckywheel {
      position: fixed;
      top: 50%;
      left: 50%;
      margin-top: -250px;
      margin-left: -250px;
    }

    .swal2-popup {
      background: rgba(255, 255, 255, 0.95) !important;
      border-radius: 20px !important;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25) !important;
      padding: 25px !important;
    }

    .swal2-title {
      color: #222 !important;
      font-size: 26px !important;
      font-weight: 700 !important;
    }

    .swal2-content {
      color: #444 !important;
      font-size: 18px !important;
      margin-top: 10px !important;
    }

    /* Fix backdrop issue */
    .swal2-backdrop-show {
      background-color: transparent !important;
    }

    /* Simple SweetAlert styling - giống popup thứ 2 */
    .simple-swal-popup {
      background: rgba(255, 255, 255, 0.98) !important;
      border-radius: 20px !important;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25) !important;
      padding: 25px !important;
    }

    .simple-swal-button {
      background: #3085d6 !important;
      border-radius: 25px !important;
      padding: 10px 25px !important;
      font-size: 16px !important;
      font-weight: 600 !important;
      border: none !important;
    }

    .simple-swal-button:hover {
      background: #2574c2 !important;
    }
  </style>
</head>

<body class="bg">
  <div id="content" class="container">
    <div id="post">
      <div class="wrapper typo" id="wrapper">
        <section id="luckywheel" class="hc-luckywheel">
          <div class="hc-luckywheel-container">
            <canvas class="hc-luckywheel-canvas" width="500" height="500">Vòng Xoay May Mắn</canvas>
          </div>
          <a class="hc-luckywheel-btn" href="javascript:;">Xoay</a>
        </section>
      </div>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
      <script src="js/hc-canvas-luckwheel.js"></script>
      <script>
        var isPercentage = true;
        var prizes = [
          {
            text: "Chúc bạn may mắn lần sau",
            img: "images/hengaplai.png",
            percentpage: 0.30
          },
          {
            text: "Check in nhận quà",
            img: "images/hsxt.png",
            percentpage: 0.15
          },
          {
            text: "Bao lì xì",
            img: "images/lixi.png",
            number: 1,
            percentpage: 0.06
          },
          {
            text: "Quạt",
            img: "images/quat.png",
            number: 1,
            percentpage: 0.06
          },
          {
            text: "Chúc bạn may mắn lần sau",
            img: "images/hengaplai.png",
            percentpage: 0.30
          },
          {
            text: "Bình nước",
            img: "images/bn.png",
            number: 1,
            percentpage: 0.05
          },
          {
            text: "Gấu Bông",
            img: "images/gau.png",
            number: 1,
            percentpage: 0.05
          },
          {
            text: "Ba lô",
            img: "images/balo1.png",
            number: 1,
            percentpage: 0.03
          }
        ];

        // SweetAlert2 cấu hình
        const Toast = Swal.mixin({
          toast: true,
          position: 'center',
          showConfirmButton: false,
          timer: 8000,
          timerProgressBar: true,
          background: 'rgba(255, 255, 255, 0)',
          backdrop: false,
        });

        document.addEventListener(
          "DOMContentLoaded",
          function () {
            hcLuckywheel.init({
              id: "luckywheel",
              config: function (callback) {
                callback && callback(prizes);
              },
              mode: "both",
              getPrize: function (callback) {
                var rand = randomIndex(prizes);
                var chances = rand;
                callback && callback([rand, chances]);
              },
              gotBack: function (data, index) {
                console.log("=== GOTBACK CALLED ===");
                console.log("Raw data:", data);
                console.log("Index:", index);

                // TẮT TOÀN BỘ SWEETALERT TỪ THỜI ĐIỂM NÀY
                const originalSwal = window.Swal;
                window.Swal = {
                  fire: function () {
                    console.log("Swal.fire blocked from library");
                    return Promise.resolve();
                  }
                };

                // Lấy thông tin prize
                let prizeText = '';
                let prizeImg = '';

                if (typeof index === 'number' && prizes[index]) {
                  prizeText = prizes[index].text;
                  prizeImg = prizes[index].img;
                } else if (typeof data === 'string') {
                  prizeText = data;
                  let foundPrize = prizes.find(p => p.text === data);
                  prizeImg = foundPrize ? foundPrize.img : '';
                }

                console.log("Final prize text:", prizeText);
                console.log("Final prize img:", prizeImg);

                // Delay để đảm bảo thư viện không gọi popup
                setTimeout(() => {
                  // KHÔI PHỤC LẠI SWAL
                  window.Swal = originalSwal;

                  // Xử lý các trường hợp
                  if (data == null || prizeText == null) {
                    originalSwal.fire({
                      title: 'Chương trình kết thúc',
                      text: 'Đã hết phần thưởng',
                      icon: 'error',
                      confirmButtonText: 'Đóng',
                      backdrop: false,
                      allowOutsideClick: false
                    });
                  } else if (prizeText === 'Chúc bạn may mắn lần sau' || prizeText.includes('may mắn')) {
                    originalSwal.fire({
                      title: 'Chúc bạn may mắn lần sau',
                      text: 'Bạn không trúng thưởng',
                      imageUrl: './images/hengaplai.png',
                      imageWidth: 100,
                      imageHeight: 100,
                      confirmButtonText: 'OK',
                      backdrop: false,
                      allowOutsideClick: false,
                      customClass: {
                        popup: 'simple-swal-popup',
                        confirmButton: 'simple-swal-button'
                      }
                    });
                  } else {
                    // Popup cho các phần thưởng khác - giao diện giống hệt popup "may mắn lần sau"
                    let displayImg = prizeImg || './images/logo.png';

                    originalSwal.fire({
                      title: 'Chúc mừng!',
                      text: `Bạn đã trúng: ${prizeText}`,
                      imageUrl: displayImg,
                      imageWidth: 100,
                      imageHeight: 110,
                      confirmButtonText: 'OK',
                      backdrop: false,
                      allowOutsideClick: false,
                      customClass: {
                        popup: 'simple-swal-popup',
                        confirmButton: 'simple-swal-button'
                      }
                    });
                  }
                }, 100);
              }
            });
          },
          false
        );

        function randomIndex(prizes) {
          if (isPercentage) {
            var counter = 0;
            for (let i = 0; i < prizes.length; i++) {
              if (prizes[i].number == 0) {
                counter++;
              }
            }
            if (counter == prizes.length) {
              return null;
            }

            let rand = Math.random();
            let prizeIndex = null;
            console.log("Random value:", rand);

            let cumulativeProbability = 0;
            for (let i = 0; i < prizes.length; i++) {
              cumulativeProbability += prizes[i].percentpage;
              if (rand < cumulativeProbability) {
                prizeIndex = i;
                break;
              }
            }

            console.log("Selected prize index:", prizeIndex, "Prize:", prizes[prizeIndex].text); // Debug log

            if (prizes[prizeIndex].number !== undefined && prizes[prizeIndex].number != 0) {
              prizes[prizeIndex].number--;
              return prizeIndex;
            } else if (prizes[prizeIndex].number === undefined) {
              return prizeIndex;
            } else {
              return randomIndex(prizes);
            }
          } else {
            var counter = 0;
            for (let i = 0; i < prizes.length; i++) {
              if (prizes[i].number == 0) {
                counter++;
              }
            }
            if (counter == prizes.length) {
              return null;
            }
            var rand = (Math.random() * (prizes.length)) >>> 0;
            if (prizes[rand].number !== undefined && prizes[rand].number != 0) {
              prizes[rand].number--;
              return rand;
            } else if (prizes[rand].number === undefined) {
              return rand;
            } else {
              return randomIndex(prizes);
            }
          }
        }
      </script>
    </div>
  </div>
</body>

</html>